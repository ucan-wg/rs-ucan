<!DOCTYPE html>
<html>
  <head>
    <title>UCANs on the Web - Powered by rs-ucan</title>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type" />
    <script type="module">
      import {
        WebCryptoRsaKeyMaterial as KeyMaterial,
        WasmUcanBuilder as UcanBuilder,
        WasmUcan as Ucan,
        default as ucanInit,
      } from "../static/ucan_key_support.js";

      function log_(msg, kind) {
        let container = document.getElementById("log");
        let node = document.createElement("div");
        node.classList.add(kind);
        node.textContent = msg;
        container.append(node);
      }

      function log(msg) {
        log_(msg, "log");
      }

      function error(msg) {
        log_(msg, "error");
      }

      async function runTest() {
        document.getElementById("log").innerHTML = "";
        let aliceKey = await KeyMaterial.generate(2048);
        let did = await aliceKey.getDid();
        log(`Alice's DID url: ${did}`);
        log(`JWT algorithm: ${aliceKey.jwtAlgorithm()}`);

        let data = new TextEncoder().encode("Hello World!");
        let signature = await aliceKey.sign(data);
        try {
          await aliceKey.verify(data, signature);
          log(`Signature successfully verified`);
        } catch (e) {
          error(`Signature verification failed: ${e}`);
        }

        let bobKey = await KeyMaterial.generate(2048);

        let builder = new UcanBuilder()
          .issuedBy(aliceKey)
          .forAudience(bobKey)
          .withLifetime(60n);
        let signable = builder.build();
        let ucan = await signable.sign();
        let encoded = ucan.encode();

        log(`Encoded ucan: ${encoded}`);

        let decodedUcan = Ucan.fromToken(encoded);
        log(`Decoded ucan validity: ${await decodedUcan.validate()}`);
        log(`Too early? ${decodedUcan.isTooEarly()}`);
      }

      document.addEventListener("DOMContentLoaded", async () => {
        document.getElementById("run-test").addEventListener("click", runTest);

        await ucanInit();
      });
    </script>
    <style>
      div.error {
        color: red;
      }
    </style>
  </head>
  <body>
    <button id="run-test">Run Test</button>
    <pre id="log"></pre>
  </body>
</html>
